# This workflow builds PHP with cURL and FTP enabled for Mac ARM (Apple Silicon)
# Place this file in .github/workflows/build-php-arm.yml in your forked repo

name: Build PHP for Mac ARM with cURL and FTP

on:
  workflow_dispatch:
  push:
    branches: [ mac130 ]

jobs:
  build-php-arm:
    runs-on: macos-14  # macos-14 is Apple Silicon (ARM64)
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare build directory
        run: |
          mkdir -p phpdesktop/php-arm64
          cd phpdesktop/php-arm64

      - name: Download all sources
        run: |
          cd phpdesktop/php-arm64
          # OpenSSL
          curl -LO https://github.com/openssl/openssl/archive/refs/tags/OpenSSL_1_1_1w.tar.gz
          tar -xzf OpenSSL_1_1_1w.tar.gz
          # libiconv
          curl -LO https://ftp.gnu.org/pub/gnu/libiconv/libiconv-1.17.tar.gz
          tar -xzf libiconv-1.17.tar.gz
          # libxml2
          curl -LO https://download.gnome.org/sources/libxml2/2.12/libxml2-2.12.5.tar.xz
          tar -xJf libxml2-2.12.5.tar.xz
          # zlib
          curl -LO https://zlib.net/zlib-1.3.1.tar.gz
          tar -xzf zlib-1.3.1.tar.gz
          # sqlite
          curl -LO https://www.sqlite.org/2023/sqlite-autoconf-3430000.tar.gz
          tar -xzf sqlite-autoconf-3430000.tar.gz
          # libpng
          curl -LO https://download.sourceforge.net/libpng/libpng-1.6.40.tar.gz
          tar -xzf libpng-1.6.40.tar.gz
          # jpeg
          curl -LO https://ijg.org/files/jpegsrc.v9e.tar.gz
          tar -xzf jpegsrc.v9e.tar.gz
          # oniguruma
          curl -LO https://github.com/kkos/oniguruma/releases/download/v6.9.9/onig-6.9.9.tar.gz
          tar -xzf onig-6.9.9.tar.gz
          # PHP
          curl -LO https://www.php.net/distributions/php-8.2.15.tar.gz
          tar -xzf php-8.2.15.tar.gz

      - name: Build dependencies and PHP
        run: |
          cd phpdesktop/php-arm64
          chmod +x ../../buildopenssl.sh ../../buildiconv.sh ../../buildxml.sh ../../buildzlib.sh ../../buildsqlite.sh ../../buildpng.sh ../../buildjpeg.sh ../../buildonig.sh ../../buildphp.sh ../../cleanbuild.sh
          ../../buildopenssl.sh
          ../../buildiconv.sh
          ../../buildxml.sh
          ../../buildzlib.sh
          ../../buildsqlite.sh
          ../../buildpng.sh
          ../../buildjpeg.sh
          ../../buildonig.sh
          ../../buildphp.sh
          ../../cleanbuild.sh

      - name: Archive built PHP
        uses: actions/upload-artifact@v4
        with:
          name: php-arm-build
          path: phpdesktop/php-arm64/php-arm-build/
